"use strict";var e=require("gm"),t=require("path"),i=require("fs"),s=require("stream");const r={quality:0,format:"png",width:768,height:512,density:72,savePath:"./",saveFilename:"untitled",compression:"jpeg"};function n(e,t,i,s){return new(i||(i=Promise))((function(r,n){function a(e){try{h(s.next(e))}catch(e){n(e)}}function o(e){try{h(s.throw(e))}catch(e){n(e)}}function h(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}h((s=s.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class a{constructor(){this.quality=0,this.format="png",this.width=768,this.height=512,this.density=72,this.savePath="./",this.saveFilename="untitled",this.compression="jpeg",this.gm=e.subClass({imageMagick:!1})}generateValidFilename(e){let i=t.join(this.savePath,this.saveFilename);return this.savePath.startsWith("./")&&(i=`./${i}`),"number"==typeof e&&(i=`${i}.${e+1}`),`${i}.${this.format}`}gmBaseCommand(e,t){return this.gm(e,t).density(this.density,this.density).resize(this.width,this.height,"!").quality(this.quality).compress(this.compression)}toBase64(e,t){return n(this,void 0,void 0,(function*(){const{buffer:i,size:s,page:r}=yield this.toBuffer(e,t);return{base64:i.toString("base64"),size:s,page:r}}))}toBuffer(e,t){const i=`${e.path}[${t}]`;return new Promise(((s,r)=>{this.gmBaseCommand(e,i).stream(this.format,((e,i)=>{const n=[];if(e)return r(e);i.on("data",(e=>{n.push(e)})).on("end",(()=>s({buffer:Buffer.concat(n),size:`${this.width}x${this.height}`,page:t+1})))}))}))}writeImage(e,s){const r=this.generateValidFilename(s),n=`${e.path}[${s}]`;return new Promise(((a,o)=>{this.gmBaseCommand(e,n).write(r,(e=>e?o(e):a({name:t.basename(r),size:`${this.width}x${this.height}`,fileSize:i.statSync(r).size/1e3,path:r,page:s+1})))}))}identify(e,t){const i=this.gm(e);return new Promise(((e,s)=>{t?i.identify(t,((t,i)=>t?s(t):e(i.replace(/^[\w\W]*?1/,"1")))):i.identify(((t,i)=>t?s(t):e(i)))}))}setQuality(e){return this.quality=e,this}setFormat(e){return this.format=e,this}setSize(e,t){return this.width=e,this.height=t||e,this}setDensity(e){return this.density=e,this}setSavePath(e){return this.savePath=e,this}setSaveFilename(e){return this.saveFilename=e,this}setCompression(e){return this.compression=e,this}setGMClass(t){return"boolean"==typeof t?(this.gm=e.subClass({imageMagick:t}),this):"imagemagick"===t.toLocaleLowerCase()?(this.gm=e.subClass({imageMagick:!0}),this):(this.gm=e.subClass({appPath:t}),this)}getOptions(){return{quality:this.quality,format:this.format,width:this.width,height:this.height,density:this.density,savePath:this.savePath,saveFilename:this.saveFilename,compression:this.compression}}}function o(e){return new s.Readable({read(){this.push(e),this.push(null)}})}function h(e,t){if("buffer"===e)return o(t);if("path"===e)return i.createReadStream(t);if("base64"===e)return s=t,o(Buffer.from(s,"base64"));var s;throw new Error("Cannot recognize specified source")}const u=e=>{var t;if(e&&"object"!=typeof e)throw new Error(`Invalid convertOptions type: ${e}`);return null!==(t=null==e?void 0:e.responseType)&&void 0!==t?t:"image"};function f(e,t,s=r){const f=new a;s=Object.assign(Object.assign({},r),s);const m=(e,t,i)=>{if(t<1)throw new Error("Page number should be more than or equal 1");const s=u(i);switch(s){case"base64":return f.toBase64(e,t-1);case"image":return f.writeImage(e,t-1);case"buffer":return f.toBuffer(e,t-1);default:throw new Error(`Invalid responseType: ${s}`)}},c=(e,t,i)=>Promise.all(t.map((t=>m(e,t,i)))),l=(i=1,s)=>{const r=h(e,t);return m(r,i,s)};return l.bulk=(s,r)=>n(this,void 0,void 0,(function*(){const a=yield function(e,t){return n(this,void 0,void 0,(function*(){if("buffer"===e)return t;if("path"===e)return yield i.promises.readFile(t);if("base64"===e)return Buffer.from(t,"base64");throw new Error("Cannot recognize specified source")}))}(e,t),h=-1===s?yield function(e,t){return n(this,void 0,void 0,(function*(){return(yield e.identify(t,"%p ")).split(" ").map((e=>parseInt(e,10)))}))}(f,o(a)):Array.isArray(s)?s:[s],u=[];for(let e=0;e<h.length;e+=10)u.push(...yield c(o(a),h.slice(e,e+10),r));return u})),l.setOptions=()=>function(e,t){return void e.setQuality(t.quality).setFormat(t.format).setSize(t.width,t.height).setDensity(t.density).setSavePath(t.savePath).setSaveFilename(t.saveFilename).setCompression(t.compression)}(f,s),l.setGMClass=e=>{f.setGMClass(e)},l.setOptions(),l}exports.fromBase64=function(e,t=r){return f("base64",e,t)},exports.fromBuffer=function(e,t=r){return f("buffer",e,t)},exports.fromPath=function(e,t=r){return f("path",e,t)};
